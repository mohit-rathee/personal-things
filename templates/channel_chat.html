<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{name}}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='post.css') }}" />
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" />
</head>

<body>
  <div class="container">
    <div class="servers">
      {% for srvr in mysrvr: %}
      <div class="text-block" onclick='gotoserver("{{srvr}}")'>
        {{srvr}}
      </div>
      {% endfor %}
    </div>
    <div class="leftside">
      <div class="header">
        <div class="imgtext">
          <a class="arrow" id="back" style="text-decoration: none; font-size: 1.1em;display: none;"><ion-icon
              name="arrow-back-outline"></ion-icon></a>
          <div class="userimg">
            <img src="{{url_for('static',filename='profile.webp')}}" alt="pic" class="cover" />
          </div>
          <h4>{{name}}<br /><span>Server:</span>&nbsp;<span id="server">{{server}}</span></h4>
        </div>
      </div>
      <div class="search_channel">
        <div id="search_form">
          <form>
            <input autocomplete="off" id="search_input" placeholder="Search channel/person" type="text"
              class="search_channel" />
          </form>
        </div>
      </div>
      <div class="channel_list" id="channel_list">
        <!-- {% for table in tables: %}
        <div class="block"
          onclick='if(document.getElementsByClassName("active").length==0){this.classList.add("active");console.log("reached")};goto("{{table.name}}")'>
          <div class="imgbx">
            <img src="{{url_for('static',filename='profile.webp')}}" alt="pic" class="cover" />
          </div>
          <div class="details">
            <div class="name">
              <h4>{{table.name}}</h4>
              <p class="time"></p>
            </div>
            <div class="creator">
              <p>created by {{table.user.username}}</p>
              <!-- <b onclick="location.href='/delete'">x</b> 
            </div>
          </div>
        </div>
        {% endfor %} -->
        <!-- profile pic will be added later -->
      </div>
    </div>
    <div class="rightside">
      <div id="userside" style="display: block;">
        <div class="header">
          <div class="useless">
            <a id="download" href="download/{{server}}">Download State</a>
            <p onclick='socket.emit("changeServer",false)' id="delete">Logout</p>
            <form id="logout" action="/servers" method="post" style="display: none;"></form>
          </div>
        </div>
        <div class="chatbox" id="user" style="height: 68vh;">
          <p>
          <h2>Welcome {{name}}</h2><br>
          </p>
          <h4>People live in <span id="server2">{{server}}</span>:</h4>
          <ul style="cursor: pointer;" type="bullet" id="userlive">
            <br>
          </ul>
        </div>
        <div class="chatbox_input">
          <form action="/app" method="post" class="form">
            <input autocomplete="off" name="channel_name" placeholder="Add channel" type="text" class="search_channel">
            <input type="submit" value="Add Topic">
          </form>
        </div>
      </div>
      <div id="chatside" style="display: none;">
        <div class="header">
          <div class="imgtext">
            <h2 id="topic">&nbsp<br /></h2>
            &nbsp<small style="
                  font-style: italic;
                  color: rgb(59, 42, 181);
                  font-size: 95%;
                  cursor: pointer;
                " id="user-names"></small>
            <ul id="user-list"></ul>
          </div>
        </div>
        <div class="chatbox" id="chats">
          <div class="arrow" onclick="gethistory()" id="UP">
            <ion-icon name="arrow-up-outline"></ion-icon>
          </div>
          <!-- {% for post in posts: %} {% if loop.previtem is not defined: %} {% if
          post.user.id==name.id: %}

          <div class="message my_message">
            <p>
              {{post.data}}<br /><span>{{post.time.strftime("%D %H:%M")}}</span>
            </p>
          </div>
          {% else: %}
          <div class="message frnd">
            <p>
              <a href="/chat/{{post.user.username}}"
                style="text-decoration: none; font-size: 1.1em">{{post.user.username}}</a>
            </p>
          </div>
          <div class="message frnd_message">
            <p>
              {{post.data}}<br /><span>{{post.time.strftime("%D %H:%M")}}</span>
            </p>
          </div>
          {% endif %}
          <script>
            let ID = "{{post.id}}";
          </script>
          {% else: %} {% if post.user.id==name.id: %}
          <div class="message my_message">
            <p>
              {{post.data}}<br /><span>{{post.time.strftime("%D %H:%M")}}</span>
            </p>
          </div>
          {% elif post.user.id==loop.previtem.user.id: %}
          <div class="message frnd_message">
            <p>
              {{post.data}}<br /><span>{{post.time.strftime("%D %H:%M")}}</span>
            </p>
          </div>
          {% else: %}
          <div class="message frnd">
            <p>
              <a href="/chat/{{post.user.username}}"
                style="text-decoration: none; font-size: 1.1em">{{post.user.username}}</a>
            </p>
          </div>
          <div class="message frnd_message">
            <p>
              {{post.data}}<br /><span>{{post.time.strftime("%D %H:%M")}}</span>
            </p>
          </div>
          {% endif %} {% endif %} {% endfor %} -->
          <hr id="breaker" />
          <!-- <div  class="useless">
                      <button onclick="darkfunction()" style="align-items:center;">chat useless</button>                   
                      <button onclick="location.href='/delete_short'" id="delete">Delete</button>
                  </div>
                  <script>
                      function darkfunction() {
                          var mybody=document.body
                          var hide=document.getElementById("inputfield")
                          if (hide.value=="True"){
                              mybody.classList.remove("darkbody");
                              hide.value="False";
                          }
                          else {
                              hide.value="True";
                              mybody.classList.toggle("darkbody");
                          }
                      }
                  </script>
                  <div class="shortBox" id="shortBox"> <p>under maintainance...<z/p>
                      {% for post in feelings: %}
                          {% if post.sender_id==name.id: %}
                              <div class="short my_short">
                                  <p>{{post.data}}</span> </p>
                              </div>
                          {% else: %}
                              <div class="short frnd_short">
                                  <p >{{post.data}} - <span>{{post.sender.username}}</p>
                              </div>
                          {% endif %}
                      {% endfor %}
                  </div> -->
          <script>
            // var objDiv1 = document.getElementById("shortBox");
            var objDiv2 = document.getElementById("chats");
            // objDiv1.scrollTop = objDiv1.scrollHeight;
            objDiv2.scrollTop = objDiv2.scrollHeight;
          </script>
        </div>

        <div class="chatbox_input" id="chatinput">
          <form class="form">
            <input autofocus autocomplete="off" type="text" name="post" placeholder="Message " id="text_message" />
            <!-- <input type="hidden" name="hide" default="False" value="{{hide}}" id="inputfield" /> -->
          </form>
        </div>
      </div>
    </div>
  </div>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <!-- adding socket -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
    integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
    crossorigin="anonymous"></script>
  <script type="text/javascript" charset="utf-8">
    var socket = io({
      transports: ["websocket"],
    });
    socket.on("connect", function () {
      socket.emit("changeServer", '{{server}}');
    });
    const chatbox = document.getElementById("chats");
    const line = document.getElementById("breaker");
    const channel_list = document.getElementById("channel_list")

    

    socket.on("showNewServer", function (data) {
      document.getElementById("server").innerText = data[0]
      document.getElementById("server2").innerText = data[0]
      document.getElementById("download").href = "/download/" + data[0]
      channel_list.innerHTML = ""
      data[1].forEach(element => {
        let channel = document.createElement("div")
        channel.classList.add("block")
        channel.innerHTML = '<div class="imgbx"><img src="/static/profile.webp" alt="pic" class="cover"></div><div class="details"><div class="name"><h4>' + element[0] + '</h4><p class="time"></p></div><div class="creator"><p>created by ' + element[1] + '</p><!-- <b onclick="location.href="/delete">x</b> --></div></div>'
        channel.setAttribute('onclick', 'goto(this)')
        channel_list.appendChild(channel)
      });
      data[2].forEach(element => {
        let channel = document.createElement("div")
        channel.classList.add("block")
        channel.innerHTML = '<div class="imgbx"><img src="/static/person.png" alt="pic" class="cover"></div><div class="details"><div class="name"><h4>' + element[0] + '</h4><p class="time"></p></div><!-- <b onclick="location.href="/delete">x</b> --></div></div>'
        channel.setAttribute('onclick', 'gotofrnd(this)')
        channel_list.appendChild(channel)
      });
      show("userside")
    })
    socket.on("refresh", function () {
      location.reload
    })
    socket.on("show_message", function (data) {
      // TO ADD NEW CHILD OF MESSAGE //
      let chat = document.createElement("div");
      chat.classList.add("message");
      if (data[0] == "{{name}}") {
        chat.classList.add("my_message");
      } else {
        chat.classList.add("frnd_message");
        var LM = document.getElementsByClassName("frnd");
        if (LM.length == 0 || LM[LM.length - 1].innerText != data[0]) {
          const Frnd = document.createElement("div");
          Frnd.classList.add("message");
          Frnd.classList.add("frnd");
          Frnd.innerHTML ='<p>'+data[0] +'</p>';
          Frnd.setAttribute('onclick','GOTOfrnd("'+data[0]+'")')
          chatbox.appendChild(Frnd);
        }
      }
      chat.innerHTML =
        "<p>" + data[1] + "<span>" + data[2] + "</span>" + "</p>";
      chatbox.appendChild(chat);
      chat.scrollIntoView();
    });

    const message_form = document.getElementById("chatinput");
    const message_input = document.getElementById("text_message");
    const search_form = document.getElementById("search_form");
    const search_input = document.getElementById("search_input");
    message_form.onsubmit = function () {
      let message = message_input.value.trim();
      if (message.length) {
        socket.emit("recieve_message", String(message));
        message_input.value = "";
      }
      return false;
    };
    search_form.onsubmit = function () {
      let search = search_input.value.trim();
      socket.emit("search_text", String(search));
      search_input.value = "";
      return false;
    };

    function gethistory() {
      socket.emit("getHistory", ID);
    }
    document.getElementById("back").onclick = function () {
      document.getElementById("topic").innerText=""
      document.getElementById("chats").innerHTML=""
      show("userside")
      socket.emit("leave_channel", document.getElementById("topic").innerText); // soon we will not send topic.id
    };
    function show(side) {
      if (side === "chatside") {
        if (document.getElementById("chatside").style.display === "none") {
          document.getElementById("userside").style.display = "none"
          document.getElementById("chatside").style.display = "block"
          document.getElementById("back").style.display = "block"
        }
      } else {
        if (document.getElementById("userside").style.display === "none") {
          document.getElementById("chatside").style.display = "none"
          document.getElementById("userside").style.display = "block"
          document.getElementById("back").style.display = "none"
          chatbox.innerHTML = ""
          if (document.getElementsByClassName("active").length != 0) {
            document.getElementsByClassName("active")[0].classList.remove("active")
          }
        }
      }
    }

    function emphasize() {
      show("chatside")
      chatbox.innerHTML =
        '<div class="arrow" onclick="gethistory()" id="UP"><ion-icon name="arrow-up-outline"></ion-icon></div><hr id="breaker">';
    }

    function goto(Newchannel) {
      let active=document.getElementsByClassName("active")
      if (active[0] != Newchannel) {
        if (active.length!=0) {
          active[0].classList.remove("active");
        }
        Newchannel.classList.add("active")
        Newchannel=Newchannel.innerText.split('\n')[0]
        document.getElementsByClassName("active")
        document.getElementById("topic").innerText = Newchannel
        emphasize()
        socket.emit("changeChannel", Newchannel);
      }
    }
    function gotofrnd(Frnd) {
      let active=document.getElementsByClassName("active")
      if (active[0] != Frnd) {
        if (active.length!=0) {
          active[0].classList.remove("active");
        }
        Frnd.classList.add("active")
        document.getElementById("topic").innerText = Frnd.innerText
        emphasize()
        socket.emit("enter_private", Frnd.innerText);
      }
    }
    function gotoserver(Newserver) {
      socket.emit("changeServer", Newserver)
    }

    socket.on("showHistory", function (data) {
      let chatbox = document.getElementById("chats");
      var top = document.getElementById("UP");
      if (data.length == 31) {
        ID = data[0];
      } else {
        top.style.visibility = "hidden";
      } //to remove _-^-_ if data<21
      Mess = document.getElementsByClassName("message")[0];
      if (!Mess) {
        Mess = document.getElementById("breaker");
      }
      for (var i = 1; i < data.length; i++) {
        var message = document.createElement("div");
        message.classList.add("message");
        if (data[i][0] == "{{name}}") {
          message.classList.add("my_message");
        } else {
          message.classList.add("frnd_message");
          if (i == 0 || data[i][0] != data[i - 1][0]) {
            var Frnd = document.createElement("div");
            Frnd.classList.add("message");
            Frnd.classList.add("frnd");
            Frnd.innerHTML ='<p>' +data[i][0]+'</p>';
            Frnd.setAttribute('onclick','GOTOfrnd("'+data[i][0]+'")')
            chatbox.insertBefore(Frnd, Mess);
          }
        }
        message.innerHTML =
          "<p>" + data[i][1] + "<span>" + data[i][2] + "</span>" + "</p>";
        chatbox.insertBefore(message, Mess);
      }
      if (Mess.classList.contains("frnd")) {
        let arr = $(Mess).prevUntil(document.getElementsByClassName("frnd"));
        var del = true;
        if (arr.length != 0) {
          for (var i = 0; i < arr.length; i++) {
            if (arr[i].classList.contains("my_message")) {
              del = false;
            }
          }
          if (del) {
            Mess.scrollIntoView();
            Mess.remove();
          }
        }
      }
      Mess.scrollIntoView();
    });
    function GOTOfrnd(user){
      let block = document.getElementsByClassName("block") 
      let create=true;
      for(let i=0;i<block.length;i++){
        if (block[i].innerText==user){
          gotofrnd(block[i])
          create=false;
        }
      }
      if (create){
        let plate=document.createElement("div")
        plate.classList.add("block")
        plate.innerHTML = '<div class="imgbx"><img src="/static/person.png" alt="pic" class="cover"></div><div class="details"><div class="name"><h4>' + user + '</h4><p class="time"></p></div><!-- <b onclick="location.href="/delete">x</b> --></div></div>'
        plate.setAttribute('onclick', 'gotofrnd(this)')
        channel_list.appendChild(plate)
        gotofrnd(plate);
      }
    }
    const userlive=document.getElementById("userlive")
    socket.on("serverlive", function(data) {
      userlive.innerHTML="";
      data.forEach(element => {
        let user = document.createElement("li");
        user.innerText=element;
        user.setAttribute('onclick','GOTOfrnd("'+element+'")')
        userlive.appendChild(user);
      })
    })
    socket.on("notify", function (data) {
      userList.innerHTML = "";
      data.forEach(element => {
        let user = document.createElement("li");
        user.innerText = element;
        user.setAttribute('onclick','GOTOfrnd("'+element+'")')
        userList.appendChild(user);
      });
      let first3 = "you";
      for (var i = 0; i < 3; i++) {
        if (data[i]) {
          if (data[i] != "{{name}}") {
            first3 += ", " + data[i];
          }
          if (i == 2) {
            first3 += "...";
          }
        }
      }
      first3 += " (" + data.length + ")";
      chatUsers.innerText = first3;
    });
    const userList = document.getElementById("user-list");
    const chatUsers = document.getElementById("user-names");
    let makevisible = true;
    let hideTimeout;
    // Handle click event
    chatUsers.addEventListener("click", () => {
      clearTimeout(hideTimeout);
      if (makevisible) {
        // chatUsers.style.color = "#004f00";
        userList.style.display = "block";
        makevisible = false;
      } else {
        // chatUsers.style.color = "rgb(59, 42, 181);";
        userList.style.display = "none";
        makevisible = true;
      }
    });

    // Handle mouseleave event
    chatUsers.addEventListener("mouseleave", () => {
      hideTimeout = setTimeout(() => {
        if (makevisible) {
          userList.style.display = "none";
        }
      }, 500);
    });
    chatUsers.addEventListener("mouseenter", () => {
      if (makevisible) {
        userList.style.display =
          userList.style.display === "block" ? "none" : "block";
      }
    });
    // Handel mouseenter event for list
    userList.addEventListener("mouseenter", () => {
      clearTimeout(hideTimeout);
      userList.style.display = "block";
    });
    // Handel mouseleave event for list
    userList.addEventListener("mouseleave", () => {
      hideTimeout = setTimeout(() => {
        if (makevisible) {
          userList.style.display = "none";
        }
      }, 500);
    });
    socket.on("Logout",function(){
      document.getElementById("logout").submit()
    })
  </script>
</body>

</html>